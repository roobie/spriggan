<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Spriggan Users Example</title>
    <style>
      body {
        font-family: system-ui;
        max-width: 800px;
        margin: 50px auto;
      }
      .user-card {
        border: 1px solid #ddd;
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
      }
      .loading {
        color: #999;
        font-style: italic;
      }
      .error {
        color: red;
      }
    </style>
  </head>
  <body>
    <div id="app"></div>

    <script src="https://unpkg.com/idiomorph@0.7.4/dist/idiomorph.min.js"></script>
    <script src="../src/spriggan.js"></script>

    <script>
      const { app, html } = Spriggan;

      // ========================================================================
      // Model
      // ========================================================================

      const init = {
        users: [],
        status: "idle", // 'idle' | 'loading' | 'success' | 'error'
        error: null,
        selectedUserId: null,
      };

      // ========================================================================
      // Update
      // ========================================================================

      function update(state, msg) {
        switch (msg.type) {
          case "FetchUsers":
            return [
              { ...state, status: "loading", error: null },
              {
                type: "http",
                url: "https://jsonplaceholder.typicode.com/users",
                onSuccess: "UsersLoaded",
                onError: "UsersFailed",
              },
            ];

          case "UsersLoaded":
            return {
              ...state,
              status: "success",
              users: msg.data,
            };

          case "UsersFailed":
            return {
              ...state,
              status: "error",
              error: msg.error,
            };

          case "SelectUser":
            return { ...state, selectedUserId: msg.id };

          case "RefreshAfterDelay":
            return [
              state,
              {
                type: "delay",
                ms: 3000,
                msg: { type: "FetchUsers" },
              },
            ];

          default:
            return state;
        }
      }

      // ========================================================================
      // View
      // ========================================================================

      function view(state, dispatch) {
        return html`
          <div>
            <h1>Spriggan Users</h1>

            <div style="margin: 20px 0;">
              <button data-msg='{"type":"FetchUsers"}'>Fetch Users</button>
              <button
                data-msg='{"type":"RefreshAfterDelay"}'
                style="margin-left: 10px;"
              >
                Refresh in 3s
              </button>
            </div>

            ${renderStatus(state)} ${renderUsers(state, dispatch)}
          </div>
        `;
      }

      function renderStatus(state) {
        if (state.status === "loading") {
          return html`<p class="loading">Loading users...</p>`;
        }

        if (state.status === "error") {
          return html`<p class="error">Error: ${state.error}</p>`;
        }

        return "";
      }

      function renderUsers(state, dispatch) {
        if (state.users.length === 0) {
          return html`<p>No users loaded. Click "Fetch Users" to load.</p>`;
        }

        return html`
          <div>
            <h2>Users (${state.users.length})</h2>
            ${state.users.map((user) => renderUserCard(user, state, dispatch))}
          </div>
        `;
      }

      function renderUserCard(user, state, dispatch) {
        const isSelected = state.selectedUserId === user.id;

        return html`
          <div
            id="user-${user.id}"
            class="user-card"
            data-key="${user.id}"
            style="${isSelected
              ? "border-color: blue; background: #f0f8ff;"
              : ""}"
          >
            <h3>${user.name}</h3>
            <p><strong>Email:</strong> ${user.email}</p>
            <p><strong>Company:</strong> ${user.company.name}</p>

            <button data-msg='{"type":"SelectUser","id":${user.id}}'>
              ${isSelected ? "Selected âœ“" : "Select"}
            </button>

            ${isSelected
              ? html`
                  <div
                    style="margin-top: 10px; padding: 10px; background: white; border-radius: 3px;"
                  >
                    <p><strong>Phone:</strong> ${user.phone}</p>
                    <p><strong>Website:</strong> ${user.website}</p>
                    <p>
                      <strong>Address:</strong> ${user.address.street},
                      ${user.address.city}
                    </p>
                  </div>
                `
              : ""}
          </div>
        `;
      }

      // ========================================================================
      // Bootstrap
      // ========================================================================

      app("#app", {
        init,
        update,
        view,
        debug: true,
      });
    </script>
  </body>
</html>
