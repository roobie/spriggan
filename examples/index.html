<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Spriggan Todo Example</title>
    <style>
      body {
        font-family: system-ui;
        max-width: 600px;
        margin: 50px auto;
      }
      .todo {
        display: flex;
        gap: 10px;
        margin: 10px 0;
      }
      .todo.done {
        opacity: 0.5;
        text-decoration: line-through;
      }
      button {
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div id="app"></div>

    <!-- Include idiomorph for efficient DOM diffing -->
    <script src="https://unpkg.com/idiomorph@0.7.4/dist/idiomorph.min.js"></script>
    //
    <!-- Include Spriggan -->
    <script src="../src/spriggan.js"></script>

    <script type="module">
      const { app, html } = Spriggan;

      // ========================================================================
      // Model
      // ========================================================================

      const init = {
        todos: [],
        input: "",
        filter: "all", // 'all' | 'active' | 'done'
        nextId: 1,
        status: "idle",
      };

      // ========================================================================
      // Update
      // ========================================================================

      function update(state, msg) {
        switch (msg.type) {
          case "FieldChanged":
            return { ...state, [msg.field]: msg.value };

          case "AddTodo":
            if (!state.input.trim()) return state;

            const newTodo = {
              id: state.nextId,
              text: state.input,
              done: false,
            };

            return {
              ...state,
              todos: [...state.todos, newTodo],
              input: "",
              nextId: state.nextId + 1,
            };

          case "ToggleTodo":
            return {
              ...state,
              todos: state.todos.map((todo) =>
                todo.id === msg.id ? { ...todo, done: !todo.done } : todo,
              ),
            };

          case "DeleteTodo":
            return {
              ...state,
              todos: state.todos.filter((todo) => todo.id !== msg.id),
            };

          case "SetFilter":
            return { ...state, filter: msg.filter };

          case "ClearCompleted":
            return {
              ...state,
              todos: state.todos.filter((todo) => !todo.done),
            };

          case "LoadTodos":
            return [
              { ...state, status: "loading" },
              {
                type: "storage",
                action: "get",
                key: "spriggan-todos",
                onSuccess: "TodosLoaded",
              },
            ];

          case "TodosLoaded":
            return {
              ...state,
              status: "idle",
              todos: msg.data?.todos || [],
              nextId: msg.data?.nextId || 1,
            };

          case "SaveTodos":
            return [
              state,
              {
                type: "storage",
                action: "set",
                key: "spriggan-todos",
                value: {
                  todos: state.todos,
                  nextId: state.nextId,
                },
              },
            ];

          default:
            return state;
        }
      }

      // ========================================================================
      // View
      // ========================================================================

      function view(state, dispatch) {
        const filteredTodos = filterTodos(state.todos, state.filter);
        const activeCount = state.todos.filter((t) => !t.done).length;
        const doneCount = state.todos.filter((t) => t.done).length;

        return html`
          <div>
            <h1>Spriggan Todos</h1>

            ${renderInput(state, dispatch)} ${renderFilters(state, dispatch)}
            ${renderTodoList(filteredTodos, dispatch)}
            ${renderStats(activeCount, doneCount, dispatch)}
          </div>
        `;
      }

      function renderInput(state, dispatch) {
        return html`
          <div style="margin: 20px 0;">
            <input
              type="text"
              data-model="input"
              value="${state.input}"
              placeholder="What needs to be done?"
              style="padding: 10px; width: 400px; font-size: 16px;"
            />
            <button
              data-msg='{"type":"AddTodo"}'
              style="padding: 10px 20px; font-size: 16px; margin-left: 10px;"
            >
              Add
            </button>
          </div>
        `;
      }

      function renderFilters(state, dispatch) {
        const filters = [
          { value: "all", label: "All" },
          { value: "active", label: "Active" },
          { value: "done", label: "Completed" },
        ];

        return html`
          <div style="margin: 20px 0;">
            ${filters.map(
              (f) => html`
                <button
                  data-msg='{"type":"SetFilter","filter":"${f.value}"}'
                  style="
                padding: 5px 15px;
                margin-right: 5px;
                ${state.filter === f.value
                    ? "font-weight: bold; background: #eee;"
                    : ""}
              "
                >
                  ${f.label}
                </button>
              `,
            )}
          </div>
        `;
      }

      function renderTodoList(todos, dispatch) {
        if (todos.length === 0) {
          return html`
            <p style="color: #999; font-style: italic;">No todos to display</p>
          `;
        }

        return html`
          <div>${todos.map((todo) => renderTodo(todo, dispatch))}</div>
        `;
      }

      function renderTodo(todo, dispatch) {
        return html`
          <div class="todo ${todo.done ? "done" : ""}" data-key="${todo.id}" id="todo-${todo.id}">
            <input
              type="checkbox"
              ${todo.done ? "checked" : ""}
              data-msg='{"type":"ToggleTodo","id":${todo.id}}'
            />
            <span style="flex: 1;">${todo.text}</span>
            <button
              data-msg='{"type":"DeleteTodo","id":${todo.id}}'
              style="padding: 5px 10px;"
            >
              Delete
            </button>
          </div>
        `;
      }

      function renderStats(activeCount, doneCount, dispatch) {
        return html`
          <div
            style="margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 5px;"
          >
            <p>
              <strong>${activeCount}</strong> active,
              <strong>${doneCount}</strong> completed
            </p>
            ${doneCount > 0
              ? html`
                  <button
                    data-msg='{"type":"ClearCompleted"}'
                    style="padding: 5px 15px;"
                  >
                    Clear Completed
                  </button>
                `
              : ""}
            <button
              data-msg='{"type":"SaveTodos"}'
              style="padding: 5px 15px; margin-left: 10px;"
            >
              Save to Storage
            </button>
          </div>
        `;
      }

      // ========================================================================
      // Helpers
      // ========================================================================

      function filterTodos(todos, filter) {
        switch (filter) {
          case "active":
            return todos.filter((t) => !t.done);
          case "done":
            return todos.filter((t) => t.done);
          default:
            return todos;
        }
      }

      // ========================================================================
      // Bootstrap
      // ========================================================================

      const sprigganApp = app("#app", {
        init,
        update,
        view,
        debug: location.href.includes('localhost'), // Enable debug mode
        subscriptions: (dispatch) => {
          // Load todos on startup
          dispatch({ type: "LoadTodos" });

          // Auto-save on keyboard shortcut
          const handleKeydown = (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === "s") {
              e.preventDefault();
              dispatch({ type: "SaveTodos" });
            }
          };

          document.addEventListener("keydown", handleKeydown);

          // Cleanup
          return () => {
            document.removeEventListener("keydown", handleKeydown);
          };
        },
      });

      // Make app available globally for debugging
      window.myApp = sprigganApp;
    </script>
  </body>
</html>
